<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard — Pomodoro • Post-its • Kanban</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#071026; --card:#0b1220; --muted:#9aa6b2; --accent:#5eead4; --accent2:#60a5fa; --danger:#fb7185;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%, #081124 60%);color:#e6eef6}
    .container{height:100vh;padding:18px;display:grid;grid-template-columns:240px 1fr 560px;gap:16px;align-items:start}
    header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#04232a}
    h1{font-size:16px;margin:0}
    .sub{color:var(--muted);font-size:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .pomodoro{display:flex;flex-direction:column;gap:12px}
    .timer{display:flex;flex-direction:column;align-items:center;gap:8px;padding:18px;border-radius:10px}
    .time{font-size:40px;font-weight:700}
    .controls{display:flex;gap:8px}
    .btn{background:var(--glass);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;color:var(--accent2);font-weight:600}
    .btn.secondary{color:var(--accent)}
    .postits{display:flex;flex-direction:column;gap:12px}
    .postit-area{min-height:360px;padding:12px;display:flex;flex-wrap:wrap;gap:12px}
    .note{width:150px;min-height:100px;padding:10px;border-radius:8px;background:linear-gradient(180deg,#fff8cc,#fff1a8);color:#07212a;box-shadow:4px 6px 18px rgba(2,6,23,0.4);position:relative;overflow:hidden}
    .note .del{position:absolute;right:6px;top:4px;cursor:pointer;color:#c026d3;font-weight:700}
    .new-note{display:flex;gap:8px}
    .kanban{display:flex;gap:12px;height:80vh}
    .column{flex:1;display:flex;flex-direction:column;gap:8px}
    .col-header{display:flex;justify-content:space-between;align-items:center}
    .list{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));overflow:auto}
    .card-item{background:#071428;padding:10px;margin-bottom:8px;border-radius:8px;cursor:grab;border:1px solid rgba(255,255,255,0.02)}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px;align-items:center}
    .copy{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:var(--muted);cursor:pointer}
    @media(max-width:1100px){.container{grid-template-columns:1fr;grid-auto-rows:min-content} .kanban{height:60vh}}
    /* small animations */
    .pulse{animation:pulse 2s infinite ease-in-out}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
  </style>
</head>
<body>
  <div class="container">
    <header style="grid-column:1/-1">
      <div class="brand"><div class="logo">DB</div><div><h1>Dashboard</h1><div class="sub">Pomodoro • Post-its • Kanban — privado (link)</div></div></div>
      <div class="row">
        <div class="muted">ID:</div>
        <div id="boardId" class="sub"></div>
        <button id="copyLink" class="copy">Copiar link</button>
      </div>
    </header>

    <!-- Pomodoro column -->
    <aside class="pomodoro card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Pomodoro</strong><div class="muted">Tempos: <span id="durLabel">25/5</span></div></div>
      <div class="timer card" id="timerCard">
        <div class="time" id="time">25:00</div>
        <div class="muted" id="phase">Foco</div>
        <div class="controls">
          <button id="startBtn" class="btn">Começar</button>
          <button id="pauseBtn" class="btn secondary">Pausa</button>
          <button id="resetBtn" class="btn">Reset</button>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <label class="muted">Foco</label><input id="focusMin" type="number" value="25" style="width:64px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit">
          <label class="muted">Descanso</label><input id="breakMin" type="number" value="5" style="width:64px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit">
        </div>
      </div>

      <div class="card muted" style="font-size:13px">
        Dica: abra pelo link em qualquer navegador. As tarefas e notas são salvas automaticamente.
      </div>
    </aside>

    <!-- Post-its column -->
    <section class="postits card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Quadro de Post-its</strong><div><button id="addNote" class="btn">Novo post-it</button></div></div>
      <div class="postit-area" id="notesArea"></div>
      <div class="muted" style="font-size:12px">Clique em um post-it para editar. Arraste com o mouse para reposicionar (posição salva).</div>
    </section>

    <!-- Kanban column -->
    <main class="kanban card">
      <div class="column">
        <div class="col-header"><strong>Para fazer</strong><button id="addTodo" class="btn">+ Item</button></div>
        <div class="list" id="todoList" ondragover="event.preventDefault()"></div>
      </div>
      <div class="column">
        <div class="col-header"><strong>Em andamento</strong></div>
        <div class="list" id="doingList" ondragover="event.preventDefault()"></div>
      </div>
      <div class="column">
        <div class="col-header"><strong>Concluído</strong></div>
        <div class="list" id="doneList" ondragover="event.preventDefault()"></div>
      </div>
    </main>

  </div>

  <!-- Firebase SDK (compat - simples de usar) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ====== SUA CONFIGURAÇÃO FIREBASE (já com as chaves que você passou) ======
    const firebaseConfig = {
      apiKey: "AIzaSyBayxIwqA3R08VHr3LmNXjtP5zXNXtr2iw",
      authDomain: "dashboard-8d602.firebaseapp.com",
      projectId: "dashboard-8d602",
      storageBucket: "dashboard-8d602.firebasestorage.app",
      messagingSenderId: "653294128032",
      appId: "1:653294128032:web:ecf3e46ea80cbffc4fb2c5",
      measurementId: "G-Z2HW4JZT28"
    };
    // =====================================================================
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Board ID (url ?id= or last local or random)
    const urlParams = new URLSearchParams(location.search);
    let boardId = urlParams.get('id') || localStorage.getItem('lastBoardId') || (function(){ const chars='abcdefghijklmnopqrstuvwxyz0123456789'; let s=''; for(let i=0;i<10;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; })();
    if(!urlParams.get('id')) history.replaceState(null,'',location.pathname+'?id='+boardId);
    localStorage.setItem('lastBoardId', boardId);
    document.getElementById('boardId').textContent = boardId;

    document.getElementById('copyLink').addEventListener('click',()=>{ const link = location.origin+location.pathname+"?id="+boardId; navigator.clipboard.writeText(link).then(()=>alert('Link copiado para a área de transferência')) })

    const docRef = db.collection('boards').doc(boardId);

    const defaultData = {
      pomodoro:{phase:'focus',remaining:1500,focusMin:25,breakMin:5,playing:false},
      notes:[],
      kanban:{todo:[],doing:[],done:[]},
      updated: firebase.firestore.FieldValue.serverTimestamp()
    }

    let localData = null;
    async function init(){
      const snap = await docRef.get();
      if(!snap.exists){ await docRef.set(defaultData); localData = defaultData }
      docRef.onSnapshot(snap=>{
        if(!snap.exists) return;
        localData = snap.data();
        localData.pomodoro = localData.pomodoro || defaultData.pomodoro;
        localData.notes = localData.notes || [];
        localData.kanban = localData.kanban || defaultData.kanban;
        renderAll();
      })
    }
    init().catch(e=>console.error(e));

    // ---------- POMODORO ----------
    const timeEl = document.getElementById('time');
    const phaseEl = document.getElementById('phase');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const focusMinIn = document.getElementById('focusMin');
    const breakMinIn = document.getElementById('breakMin');
    const durLabel = document.getElementById('durLabel');

    let timerInterval = null;

    function secToDisplay(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}` }

    function renderPomodoro(){
      const p = localData.pomodoro;
      timeEl.textContent = secToDisplay(p.remaining);
      phaseEl.textContent = p.phase==='focus'?'Foco':'Descanso';
      focusMinIn.value = p.focusMin;
      breakMinIn.value = p.breakMin;
      durLabel.textContent = `${p.focusMin}/${p.breakMin}`;
      if(p.playing && !timerInterval) startTick();
      if(!p.playing && timerInterval){ clearInterval(timerInterval); timerInterval=null }
    }

    function startTick(){ if(timerInterval) return; timerInterval = setInterval(async ()=>{
        if(!localData) return;
        localData.pomodoro.remaining -=1;
        if(localData.pomodoro.remaining<=0){
          if(localData.pomodoro.phase==='focus'){
            localData.pomodoro.phase='break';
            localData.pomodoro.remaining = localData.pomodoro.breakMin*60;
            playAlarm();
          } else {
            localData.pomodoro.phase='focus';
            localData.pomodoro.remaining = localData.pomodoro.focusMin*60;
            playAlarm();
          }
        }
        timeEl.textContent = secToDisplay(localData.pomodoro.remaining);
        try{ await docRef.update({ 'pomodoro': localData.pomodoro, updated: firebase.firestore.FieldValue.serverTimestamp() }) }catch(e){console.error(e)}
      },1000) }

    startBtn.addEventListener('click',async ()=>{ localData.pomodoro.playing = true; await docRef.update({ 'pomodoro': localData.pomodoro, updated: firebase.firestore.FieldValue.serverTimestamp() }) })
    pauseBtn.addEventListener('click',async ()=>{ localData.pomodoro.playing = false; await docRef.update({ 'pomodoro': localData.pomodoro, updated: firebase.firestore.FieldValue.serverTimestamp() }) })
    resetBtn.addEventListener('click',async ()=>{ localData.pomodoro.phase='focus'; localData.pomodoro.remaining = localData.pomodoro.focusMin*60; localData.pomodoro.playing=false; await docRef.update({ 'pomodoro': localData.pomodoro, updated: firebase.firestore.FieldValue.serverTimestamp() }) })

    focusMinIn.addEventListener('change',async ()=>{ localData.pomodoro.focusMin = parseInt(focusMinIn.value)||25; localData.pomodoro.remaining = localData.pomodoro.focusMin*60; await docRef.update({ 'pomodoro': localData.pomodoro, updated: firebase.firestore.FieldValue.serverTimestamp() }) })
    breakMinIn.addEventListener('change',async ()=>{ localData.pomodoro.breakMin = parseInt(breakMinIn.value)||5; await docRef.update({ 'pomodoro': localData.pomodoro, updated: firebase.firestore.FieldValue.serverTimestamp() }) })

    // ---------- NOTES (post-its) ----------
    const notesArea = document.getElementById('notesArea');
    document.getElementById('addNote').addEventListener('click',()=>{
      const note = { id: (function(){ let s=''; const c='abcdefghijklmnopqrstuvwxyz0123456789'; for(let i=0;i<10;i++) s+=c[Math.floor(Math.random()*c.length)]; return s })(), text: 'Nova nota', x:0,y:0,w:150,h:120,color:'#fff8cc' }
      localData.notes.push(note);
      docRef.update({'notes': localData.notes, updated: firebase.firestore.FieldValue.serverTimestamp()})
    })

    function renderNotes(){
      notesArea.innerHTML='';
      (localData.notes||[]).forEach(n=>{
        const el = document.createElement('div'); el.className='note'; el.draggable=true; el.style.width = (n.w||150)+'px'; el.style.minHeight=(n.h||100)+'px'; el.style.background = n.color||'#fff8cc';
        el.dataset.id = n.id;
        el.innerHTML = `<div class=del title=Remover>✕</div><div contenteditable class=text>${escapeHtml(n.text)}</div>`;
        el.querySelector('.del').addEventListener('click',async ()=>{ localData.notes = localData.notes.filter(x=>x.id!==n.id); await docRef.update({'notes': localData.notes, updated: firebase.firestore.FieldValue.serverTimestamp()}) })
        const txt = el.querySelector('.text'); txt.addEventListener('input',debounce(async ()=>{ const noteObj = localData.notes.find(x=>x.id===n.id); if(noteObj){ noteObj.text = txt.innerText; await docRef.update({'notes': localData.notes, updated: firebase.firestore.FieldValue.serverTimestamp()}) } },600))
        el.addEventListener('dragstart',ev=>{ ev.dataTransfer.setData('text/plain', n.id) })
        notesArea.appendChild(el)
      })
    }

    // ---------- KANBAN ----------
    const todoList = document.getElementById('todoList');
    const doingList = document.getElementById('doingList');
    const doneList = document.getElementById('doneList');

    document.getElementById('addTodo').addEventListener('click',async ()=>{
      const text = prompt('Texto da tarefa:'); if(!text) return;
      localData.kanban.todo.push({id:(function(){ let s=''; const c='abcdefghijklmnopqrstuvwxyz0123456789'; for(let i=0;i<10;i++) s+=c[Math.floor(Math.random()*c.length)]; return s })(),text}); await docRef.update({'kanban': localData.kanban, updated: firebase.firestore.FieldValue.serverTimestamp()})
    })

    function makeCard(item){ const el = document.createElement('div'); el.className='card-item'; el.draggable=true; el.dataset.id=item.id; el.textContent = item.text; el.addEventListener('dragstart',ev=>ev.dataTransfer.setData('text/plain',item.id)); return el }

    function renderKanban(){
      todoList.innerHTML=''; doingList.innerHTML=''; doneList.innerHTML='';
      (localData.kanban.todo||[]).forEach(i=>todoList.appendChild(makeCard(i)));
      (localData.kanban.doing||[]).forEach(i=>doingList.appendChild(makeCard(i)));
      (localData.kanban.done||[]).forEach(i=>doneList.appendChild(makeCard(i)));

      [todoList,doingList,doneList].forEach(list=>{
        list.ondrop = async ev=>{
          ev.preventDefault(); const id = ev.dataTransfer.getData('text/plain'); if(!id) return;
          ['todo','doing','done'].forEach(k=>{ localData.kanban[k]=localData.kanban[k].filter(x=>x.id!==id) });
          const draggedEl = document.querySelector('[data-id="'+id+'"]');
          const draggedText = (draggedEl && draggedEl.textContent) || 'Tarefa';
          const targetKey = list.id.replace('List','').toLowerCase();
          localData.kanban[targetKey].push({id:id,text:draggedText});
          await docRef.update({'kanban': localData.kanban, updated: firebase.firestore.FieldValue.serverTimestamp()})
        }
      })
    }

    function renderAll(){ if(!localData) return; renderPomodoro(); renderNotes(); renderKanban(); }

    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }
    function debounce(fn,wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait) } }

    setInterval(()=>{ if(localData) renderAll() },800);
    window.addEventListener('beforeunload',()=>{ try{ docRef.update({updated: firebase.firestore.FieldValue.serverTimestamp()}) }catch(e){} })

    // sounds
    function playClick(){ try{ new Audio("https://assets.mixkit.co/active_storage/sfx/232/232.wav").play() }catch(e){} }
    function playAlarm(){ try{ new Audio("https://assets.mixkit.co/active_storage/sfx/2018/2018.wav").play() }catch(e){} }

  </script>
</body>
</html>
